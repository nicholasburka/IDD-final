<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>Old Cell</title>
</head>
<body>
	 <script src="paho-mqtt.js"
  type="text/javascript"></script>
	<script>
	mqtt = Paho.MQTT;
	console.log(mqtt);
	//from https://www.npmjs.com/package/paho-mqtt
	client = new mqtt.Client('farlab.infosci.cornell.edu', Number(1883), "clientId");

	client.onConnectionLost = onConnectionLost;
	client.onMessageArrived = onMessageArrived;

	client.connect({onSuccess:onConnect, 
		onFailure:onFailure,
		userName: 'idd', 
		password:'device@theFarm', 
		uris:['ws://farlab.infosci.cornell.edu:1883', 'ws://farlab.infosci.cornell.edu:8883', 'ws://broker.hivemq.com:8000/mqtt'],
		reconnect: true
		//uris:['ws://broker.hivemq.com:8000/mqtt']
	});

	var this_net_id = 0;
	const net_id_length = 5;

	//from https://stackoverflow.com/questions/1349404/generate-random-string-characters-in-javascript
	function rand_id(length) {
		var result = '';
		var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
		var charactersLength = characters.length;
		for ( var i = 0; i < length; i++ ) {
			result += characters.charAt(Math.floor(Math.random()*charactersLength));
		}
		return result;
	}

	function onConnect() {
		client.subscribe('oldphone-handshake');
		this_net_id = rand_id(net_id_length);
		message = new mqtt.Message(this_net_id);
		message.destinationName = 'oldphone-handshake';
		client.send(message);
		console.log('connected');
	}
	console.log('test');

	function onMessageArrived(message) {
		console.log("onMessageArrived"+message.payloadString);
		//if two devices respond at same time
		if (message.payloadString.substr(0,net_id_length) === this_net_id) {
			console.log("received handshake netid conf from server");
			client.unsubscribe('oldphone-handshake');
			client.subscribe(this_net_id);
		}
	}

	function onFailure(response) {
		console.log("connection to mqtt broker failed");
		console.log(response);
	}

	function onConnectionLost(responseObject) {
		if (responseObject.errorCode !== 0) {
			console.log("onConnectionLost:"+responseObject.errorMessage);
		}
		else {
			console.log("onConnectionLost:");
			console.log(responseObject);
		}
	}
	</script>
</body>
</html>